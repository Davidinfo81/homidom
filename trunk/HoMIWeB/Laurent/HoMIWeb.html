<!DOCTYPE html>
<html>
    <head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
		<title>HoMIDoM Interface Web</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
	    <!-- Bootstrap CSS -->
        <link href="css/bootstrap.css" rel="stylesheet" />	
        <link href="css/homiweb.css" rel="stylesheet" />
        <link href="css/bootstrap-slider.css" rel="stylesheet" />
		
		
		<!-- jQuery (necessary for Bootstrap's JavaScript plugins) --></!-->
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.js"></script>
		<script src="js/bootstrap.js"></script>	
		<script src="js/bootstrap-slider.js"></script>	
		<script src="js/jquery.jsonp-2.4.0.min.js"></script>
		<script src="js/jquery.signalR.min.js"></script>
		
		<script src="http://"+ServerName+":"+PortActuel+"/live/signalr/hubs/"></script>		
	
        <title>Bootstrap in practice: the grid system</title>
		  
    </head>

	<body>
	<script type="text/javascript" >
			// pour Debug 
			//var ServerName = "LocalHost";
			//var PortActuel = "7999";	
			//var  IDSERVERActuel = "123456789";
			//var AdresseIPActuel ="localhost";
			
			var ZoneIDText = "##";
			var ListDevices = [];
			var ListZones = [];
			
			var SiteActuel= sessionStorage.SiteActuel;
			var ZoneActuel="" ;
			// alert('Le site actuel est : ' + SiteActuel );
		
			var key = localStorage.key(SiteActuel);
	   		var InfosServeur = JSON.parse(localStorage.getItem(key));
			var ServerName = InfosServeur.AdresseIP;
			var PortActuel = InfosServeur.Port;
			var IDSERVERActuel = InfosServeur.IDSERVER;
			var AdresseIPActuel = InfosServeur.AdresseIP;
			//alert('Le site actuel est : ' +ServerName + " / " + PortActuel);
			

	</script>
	
	
	<header>
		<div class="row">
            <div class="col-md-2 col-lg-2">
				<script type="text/javascript" >
					var d = new Date();
					document.write("<h3>Nous sommes le :</h3>");
					document.write("<h2>"+d.toLocaleDateString().charAt(0).toUpperCase()+ d.toLocaleDateString().slice(1)+"</h2>");
					document.write("<h2>"+ServerName.toUpperCase() +' : '+ PortActuel + "</h2>");	
					var myVar = setInterval(function(){myTimer()},60000);
					function myTimer()
					{
						loadDevices(ListDevices);
						AfficheZone(ZoneActuel);
						var d = new Date();
						var t = d.getHours()+":"+d.getMinutes();
						document.getElementById("HeureTest").innerHTML=t;
					}
				</script>
			</div>			
            <div class="col-md-7 col-lg-7">
				<div class="navbar-text navbar-left">
					<img  class="LogoHeader" alt="Information sur l'image" src="./images/Rond_64x64.png"/>   
					<h1> HoMIDoM - <small> Le système complet de domotique pour la maison</small></h1>
				</div>
			</div>
			<div class="col-md-3 col-lg-3">
				<span class="InfoSoleil" >
					<span id="LeverSoleil"><div class="align_image"><img src="./Images/icones/01.png" /></div><p id="HeureLever">  :  </p></span>	
					<span id="CoucherSoleil"><div class="align_image"><img src="./Images/icones/36.png" /></div><p id="HeureCoucher">  :  </p></span>	
					<span id="HeureTest"> :  </span>		
			</span>	
			</div>
		</div>
		</br>
	</header>
	
	<div class="content">		
		<div class="row">
		   <div class="col-lg-2">
		   <button id="CloseZones" class="btn btn-default btn-xs dropdown-toggle navbar-left" data-toggle="dropdown">
					<span  class="caret"></span>
			</button>
			<script>
				$("#CloseZones").click(function(){
					$("#zones").toggle();
					$("#zonesTitle").toggle();
				});
			</script>		
		   <div class="col-lg-12">
		   		<h2 id="zonesTitle" class="text-center">Zones</h2>
					<div id="zones" class="list-group"></div>	
			</div>
			</div>
		   <div class="col-lg-8">
				<div class="col-lg-12">
					<h2 class="text-center" onclick="javascript:AfficheZone(ZoneActuel);" >Devices</h2>
						<div id="devices"></div>
				</div>
				<div class="col-lg-12">
					<h2 class="text-center" >Macros</h2>
				<div id="macros"></div>
				</div>
			</div>
		   <div class="col-lg-2">
				<button id="CloseEvents" class="btn btn-default btn-xs dropdown-toggle navbar-right" data-toggle="dropdown">
					<span  class="caret"></span>
				</button>
				<script>
					$("#CloseEvents").click(function(){
						$("#events").toggle();
						$("#eventsTitle").toggle();
					});
				</script>		
			   <div class="col-lg-12">
						
					<h2 id="eventsTitle" class="text-center">Events Log</h2>	
					<div id="events">
							<p></p>	
					</div>
				</div>
			</div>
		</div>
	</div>
	
			<script type="text/javascript">
			var devices;
		
			$(document).ready(function () {
				$.jsonp({
					url: 'http://'+ ServerName + ':'+ PortActuel + '/api/'+ IDSERVERActuel + '/device/',
					callbackParameter: "callback",
					success: loadDevices,
					error: onError
				})
				$.jsonp({
					url: 'http://'+ ServerName + ':'+ PortActuel + '/api/'+ IDSERVERActuel + '/zone/',
					callbackParameter: "callback",
					success: loadZones,
					error: onError
				})
				$.jsonp({
					url: 'http://'+ ServerName + ':'+ PortActuel + '/api/'+ IDSERVERActuel + '/macro/',
					callbackParameter: "callback",
					success: loadMacros,
					error: onError
				})
				$('#btnTest').click(function(){
				// 	$.connection.NotificationHub.server.test("Test");
				});

				var connection = $.hubConnection('http://'+ ServerName + ':' + PortActuel + '/live');
				var nHubProxy = connection.createHubProxy('NotificationHub');
				nHubProxy.on('DeviceChanged', function (id, value) {
					console.log(id + ' = ' + value);
					var dName = getDeviceName(id, value);
					var currentdate = new Date(); 
					var time = currentdate.getHours() + ":"  + currentdate.getMinutes() + ":" + currentdate.getSeconds();
					$('#events').prepend(time+' / '+ id + '- '+dName+' = ' + value + '<br/>');
					document.getElementById('HeureLever').innerHTML = '06:17';
					document.getElementById('HeureCoucher').innerHTML = '20:32';
					if (ZoneActuel) {
						AfficheZone(ZoneActuel);
					}
				});
				
				connection.qs = { "sKey" : '123456789' };
				connection.start()
					.done(function(){ console.log('Now connected, connection ID=' + connection.id); })
					.fail(function(){ console.log('Could not connect'); });
			});
			
			function onError(jqXHR, textStatus, errorThrown ) {
				alert('erreur:' + textStatus);
			}
			
			function getDeviceName(id, value) {
				for (var a=0; a < ListDevices.length; a++)
				{
					 if (ListDevices[a]._ID == id) {
					 	 ListDevices[a]._Value = value; 
						 return ListDevices[a]._Name;
					}
				}
			}
			
			function loadDevices(data) {
				var items = [];
				ListDevices = data;
			}
			
			function loadZones(data) {
				var items = [];
				ListZones = data;

				$.each(ListZones, function(index, zone) {
					items.push('<a href="#" class="list-group-item" onclick="AfficheZone(\''+zone._Id+'\');"><img src="images/icones/Defaut.png">' + zone._Name + '</a>');
				});

				$('<div/>', {
					'class': 'nav nav-tabs',
					html: items.join('')
				}).appendTo('#zones');
			}
			

			function loadMacros(data) {
				var items = [];
				$.each(data, function(index, macro) {
					items.push('<article class="align_macro"><h4>'+ macro._Nom + '</h4><div class="align_image"><img src="./images/icones/Macro_64.png" alt="" /><button class="btn btn-danger btn-lg" onClick="executeMacro(\''+macro._ID+'\')"> Lancer </button></div></article> ' );
					
				});
				$('<ul/>', {
					'class': 'MenuZone',
					html: items.join('')
				}).appendTo('#macros');
			}
			
			function execute(deviceId, command) {
				$.jsonp({
					url: 'http://'+ ServerName + ':'+ PortActuel + '/api/'+ IDSERVERActuel + '/command/device/'+deviceId+'/'+command,
					
					type: 'GET',
					callbackParameter: "callback",
					success: onExecuteSuccess,
					error: onError
				})
			}
			
			
			function executeMacro(macroId) {
				$.jsonp({
					url: 'http://'+ ServerName + ':'+ PortActuel + '/api/'+ IDSERVERActuel + '/command/macro/'+macroId+'/EXEC',
					type: 'GET',
					callbackParameter: "callback",
					success: onExecuteSuccess,
					error: onError
				})
			}

			function onExecuteSuccess() {
				// alert('Commande executée');
			}
			function ExecuteDIM(Device,Command) {
				 document.getElementById(Device._Name+"Slider").innerHTML =this.value; 
				 execute(Device._ID+'\', \''+command.Nom+'?Variation='+this.value); 
				//  alert('Commande Dim executée');
			}
			
			function AfficheZone(ZoneDefined) {
					var items = [];
					var FirstItem = false;
					ZoneActuel = ZoneDefined; 	
				// Debug	
				//alert("passage par la fonction AfficheZone : "+ZoneDefined);
				
				ZoneIDText = ZoneDefined; 
				// alert('L Id de la zone est : ' + ZoneIDText );	
				// Supprime les elements deja affichés
				$('#devices').empty();
				
				$.each(ListZones, function(index, zone) {
					if (zone._Id == ZoneDefined){
						for (var i=0; i < zone._ListElement.length; i++)
						{
							if (zone._ListElement[i]._Visible) 
							{
								for (var a=0; a < ListDevices.length; a++)
							 	{
									if ( ListDevices[a]._ID == zone._ListElement[i]._ElementID)
									{
										// Widget Météo
										if (ListDevices[a]._Type==17) {
										items.push('<section id="WidMeteo"><h1>'+ListDevices[a]._Name + '</h1><h2>Actuellement</h2><div class="MeteoJour" title="Méteo actuelle"><article class="Info"><img src="./Images/meteo/'+ ListDevices[a]._IconActuel +'.png" /><h3>'+ListDevices[a]._JourToday + '</h3></article><article class="Info"><img src="./Images/meteo/temperature-defaut.png" /><h3>'+ListDevices[a]._TempActuel+ '°</h3></article><article class="Info"><img src="./Images/meteo/humidite-defaut.png" /><h3>'+ ListDevices[a]._HumActuel + '%</h3></article><article class="Info"><img src="./Images/meteo/vitessevent-defaut.png" /><h3>'+ListDevices[a]._VentActuel+ '</h3></article></div><div class="MeteoPrev" title="Prévisions"><article class="Prev"><img src="./Images/meteo/'+ListDevices[a]._IconActuel + '.png" /><h4>'+ListDevices[a]._JourToday + '</h4><span title="Min" class="TempMin">'+ ListDevices[a]._MinToday + '°</span><span title="Max" class="TempMax">'+ ListDevices[a]._MaxToday + '°</span></article><article class="Prev"><img src="./Images/meteo/'+ ListDevices[a]._IconJ1 + '.png" /><h4>'+ ListDevices[a]._JourJ1 + '</h4><span title="Min" class="TempMin">'+ ListDevices[a]._MinJ1 + '°</span><span title="Max" class="TempMax">'+ ListDevices[a]._MaxJ1 + '°</span></article><article class="Prev"><img src="./Images/meteo/'+ ListDevices[a]._IconJ2 + '.png" /><h4>'+ ListDevices[a]._JourJ2 + '</h4><span title="Min" class="TempMin">'+ ListDevices[a]._MinJ2 + '°</span><span title="Max" class="TempMax">'+ ListDevices[a]._MaxJ2 + '°</span></article><article class="Prev"><img src="./Images/meteo/'+ ListDevices[a]._IconJ3 + '.png" /><h4>'+ ListDevices[a]._JourJ3 + '</h4><span title="Min" class="TempMin">'+ ListDevices[a]._MinJ3 + '°</span><span title="Max" class="TempMax">'+ ListDevices[a]._MaxJ3 + '°</span></article></div>');
										items.push('</section>');		
										} 
										else {
										
										items.push('<article><h4>'+ListDevices[a]._Name + '</h4><div class="align_image"><img src="./images/devices/'+ListDevices[a]._Type+'-defaut.png" alt="" /> ' );
										var actions = [];
										actions.push('<div id="ListCommand" class="btn-group"><button class="btn btn-danger"> ' + ListDevices[a]._Value+ '</button>');
										actions.push('<button class="btn btn-danger dropdown-toggle" data-toggle="dropdown">');
										actions.push('<span class="caret"></span></button>');
										
										actions.push('<ul class="dropdown-menu">');
										$.each(ListDevices[a]._DeviceAction, function(i, command) {
																						
											if (command.Nom == "DIM"){
											    actions.push('<li class="command"><span id="Slider"><input type="range" min="0" max="100" step="5" value="50" onchange="document.getElementById(\''+ListDevices[a]._Name+"Slider"+'\').innerHTML =this.value; execute(\''+ListDevices[a]._ID+'\', \''+command.Nom+'?Variation=this.value\'); \"  /><span id=\''+ListDevices[a]._Name+"Slider" + '\'class="badge pull-right"></span></span></li>');
											}
											 
											else {
												actions.push('<li class="command"><a href="#" onClick="execute(\''+ListDevices[a]._ID+'\', \''+command.Nom+'\')">' +command.Nom + '</a></li>');
										}
				    					  
										});
										 items.push(actions.join(''));	
										 items.push('</ul></div></article>');	
										} 
									}
								}
							}			 
						}
					}
				});

				$('<ul/>', {
					'class': 'devices',
					html: items.join('')
				}).appendTo('#devices');
			}		
	</script>

	<footer>
		<p id="ZoneID"></p>
		<!-- <button id="btnTest" onclick="javascript:AfficheZone(ZoneActuel);">Rafraichir</button>	-->	
		<hr/>
			<a href="http://homidom.com"> HoMIDoM © 2011</a>	
			<br />
			<a href="http://www.homidom.com/mentions-legales-c2.html"> Mentions Légales </a>	
	</footer>	  
    </body>
</html>