<!DOCTYPE html>
<html lang="fr">
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<title>HoMIDoM Interface Web</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    
	<script type='text/javascript' src='js/jquery-1.11.0.min.js'></script>
	<script type='text/javascript' src='js/knockout-3.1.0.js'></script>
	<script type='text/javascript' src='js/jquery.jsonp-2.4.0.min.js' ></script>
	<script type='text/javascript' src='js/jquery.signalR.min.js' ></script>
   	<script type='text/javascript' src="js/menulogin.js"></script>  
	
	<!-- Include all compiled plugins (below), or include individual files as needed 
	     necessaire pour tooltip -->
    <script src="js/bootstrap.min.js"></script>
		
	<!-- Bootstrap CSS -->
	<link href="css/bootstrap.min.css" rel="stylesheet"> 
	<link href="css/bootstrap.css" rel="stylesheet" />
	<link href="css/homiweb.css" rel="stylesheet" />	

	<!-- Definition constante -->
	<script> var VersionHomiWeb = "3.1.1";</script>

</head>

<body >
	<header>
		<!-- Definition de la partie haute de l'ecran ></!-->
		
		<div class="row" id="header">
			<!-- Definition de la partie gauche ></!-->
            <div id="ZoneDate" class="col-md-2">

			</div>	<!-- Fin partie gauche  ></!-->
			<span>
			</span>
			

			<!-- Definition de la partie centrale  ></!-->
            <div class="col-xs-7">
				<div class="navbar-text navbar-left">
					<img  class="LogoHeader" alt="Information sur l'image" src="./images/rond_64x64.png"/>   
					<h1> HoMIDoM - <small> Le système complet de domotique pour la maison</small></h1>
				</div>
			</div> <!-- Fin partie centrale  ></!-->
			<!-- Definition de la partie droite  ></    data-bind='text: name' !--> 
			<div class="col-xs-3">
				<div class="InfoSoleil" >
					<span id="LeverSoleil"   class="align_image"><img alt="" src="./images/icones/01.png" /><strong data-bind="text: HeureLever">:</strong></span>
					<span id="CoucherSoleil" class="align_image"><img alt="" src="./images/icones/36.png" /><strong data-bind="text: HeureCoucher"></strong></span>	
					<span id="HeureTest"     class="align_image"><img alt="" src="./images/icones/horloge-icone-4138-48.png" /><strong data-bind="text: HeureAffiche"></strong></span>			
				</div>	
				</br>
				<div class="ModalBoutons"> 
					<button class="btn btn-lg btn-default" data-toggle="modal" data-target="#modalLogin" title="Parametres de connexion"  ><span  style="color: gray;" class=" glyphicon glyphicon-home"></span></button>
					<button class="btn btn-lg btn-danger" data-toggle="modal" data-target="#modalApropos" title="A propos de"  ><span class="glyphicon glyphicon-gift" style="color: white;"></span></button>
				</div>
			</div> <!-- Fin partie droite  ></!-->
		</div><!-- Fin Definition de la partie haute de l'ecran ></!-->

		

		<div class="modal fade" id="modalLogin" tabindex="-1" role="dialog" aria-hidden="false">
		  <div class="modal-dialog modal-lg">
			<div class="modal-content">
			  <div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title">CONNEXION</h4>
			  </div>
			  
			  <div class="modal-body">
				  <div id="ListeServeurs" data-bind='foreach: ListeServeurs' > 
						<button type="button" class="btn btn-danger btn-small" data-bind="click: function(data, event) { AfficheSite($index()); }"><img alt="" src="images/icones/home_128.png" /><span data-bind='text: SERVER'></span></button>
				  </div>
			  
				<div  class="ListeChamp">
					<div class="input-group">
					  <span class="input-group-addon"  >Nom</span>
					  <input type="text" class="form-control" placeholder="Nom du site" id="ServerName" data-toggle="tooltip" data-placement="top" title="Par ex : Serveur de test">
					</div>
					<div class="input-group">
					  <span class="input-group-addon" >ID Server</span>
					  <input id="ServerID" class="form-control" type="text" title="" data-placement="top" data-toggle="tooltip" onfocus="onFocus(this)" onblur="onBlur(this)" value="123456789" data-original-title="Valeur par défaut : 123456789">
					</div>
					<div class="input-group">
					  <span class="input-group-addon" >Adresse IP</span>
					  <input type="text" class="form-control"  id="ServerIP" placeholder="AdresseIP ou nom ordinateur" data-toggle="tooltip" data-placement="top" title="par ex : localhost 192.168.1.1">
					</div>
					<div class="input-group">
					  <span class="input-group-addon" >Port</span>
					  <input id="ServerPort" class="form-control" type="text" title="" data-placement="top" data-toggle="tooltip" onfocus="onFocus(this)" onblur="onBlur(this)" value="7999" data-original-title="valeur par défaut : 7999">
					</div>
					<div class="input-group">
						<span class="input-group-addon" ><input type="checkbox" id="ServerDef" > </span>
						<span  class="form-control">Serveur par défaut</span>
					</div>
					<div class="action">
						<button type="button" class="btn btn-default btn-lg" onClick="AjouterSite();"><span class="glyphicon glyphicon glyphicon glyphicon-save"></span> Ajout </button>
						<button type="button" class="btn btn-default btn-lg"  onClick="SupprimeSite();" > <span class="glyphicon glyphicon glyphicon glyphicon-remove-circle"></span> Suppresssion</button>
					</div>	
				</div>	
					
			  </div>
			  <div class="modal-footer">
				<button type="button" class="btn btn-danger btn-lg" onClick="ClickBouton();" title="Se connecter au site" >  <span class="glyphicon glyphicon glyphicon  glyphicon-home"></span> Se connecter</button>

				<button type="button" class="btn btn-danger btn-lg" data-dismiss="modal">Fermer</button>
			  </div>
			</div>
		  </div>
		</div>
		<!-- fin Modal Connexion  ></!-->
			
		<div class="modal fade" id="modalApropos" tabindex="-1" role="dialog" aria-labelledby="modalApropos" aria-hidden="true">
		  <div class="modal-dialog modal-lg">
			<div class="modal-content">
			  <div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title">A PROPOS - Homiweb <script type="text/javascript" >document.write(" "+VersionHomiWeb); </script></h4>
			  </div>
			  <div class="modal-body">
				<h2><strong>HoMIDoM</strong></h2>
				<p> est un logiciel complet de de gestion de système domotique multi-technologies </p>
				<p> pour la maison sous Microsoft Windows.</p>
				<p> Homidom est un projet Open-Source (libre) proposé gratuitement à toute la communauté !</p>
				<br/>
				<a target="_blank" href="http://www.homidom.com/index.html"><img  alt="Homidom - Le système complet de domotique pour la maison"  src="./images/logo-homidom.png"/> </a>
				<h4><br/>Vous souhaitez soutenir le projet ? </h4>
				<a target="_blank"  href="http://www.homidom.com/dons-c29.html"><img  alt="Faites un don"  src="./images/fairedon.png"/></a>   
			  </div>
			  <div class="modal-footer">
				<button type="button" class="btn btn-danger btn-lg" data-dismiss="modal">Fermer</button>
			  </div>
			</div>
		  </div>
		</div>
		<!-- fin Modal A Propos  ></!-->
		
	</header>
		<div class="content">		
		<!-- Menu de gauche -->	
			<div id="PartGauche" class="col-md-2">
				<div class="box"> <!-- -->
				<button id="CloseZones" class="btn btn-default btn-xs dropdown-toggle navbar-right" data-toggle="dropdown">
					<span  class="caret"></span>
				</button>
				<script>
					$("#CloseZones").click(function(){
						$("#zones").toggle();
						$("#zonesTitle").toggle();
					});
				</script>		
					<h2 id="zonesTitle" class="text-center">Zones</h2>
						<div id="zones" class="list-group" data-bind="template: { name: 'ZonesTemplate', foreach: zones }" ></div>
						
						<script type="text/html" id="ZonesTemplate">
								<button class="btn btn-default btn-lg" data-bind="click: function(data, event) { AfficheZone(id, data, event) }"><img src="images/icones/defaut.png"><span data-bind='text: name' /></button>
						</script>
				</div>
			</div>
			
			<div id="PartCentrale" class="col-xs-7">
				<div>
					<div class=" box ">
						<h2 class="text-center" >Devices</h2>
							<div id="devices">
							</div>
					</div>
					<div class="box ">
						<h2 class="text-center" >Macros</h2>
						<div id="macros" >
							<div data-bind="template: { name: 'MacrosTemplate', foreach: macros }" ></div>
								<script type="text/html" id="MacrosTemplate">
									<article class="align_macro"><h4 data-bind="text: name"/></h4>
									<div class="align_image"><img src="./images/icones/macro_64.png" alt="" />
									<button class="btn btn-danger btn-lg"  data-bind="click: function(data, event) { executeMacro(id, data, event) }">Lancer</button></div></article> 
								</script>	
						</div>	
					</div>
				</div>
			</div>
			
		    <div id="PartDroite" class="col-xs-3 ">
			   <div class="box"> 
				<button id="CloseEvents" class="btn btn-default btn-xs dropdown-toggle navbar-right" data-toggle="dropdown">
					<span  class="caret"></span>
				</button>
				<script>
					$("#CloseEvents").click(function(){
						$("#events").toggle();
						$("#eventsTitle").toggle();
					});
				</script>		
						
					<h2 id="eventsTitle" class="text-center">Events Log</h2>	
					<div id="events">
							<p></p>	
					</div>
				</div>
			</div>
		</div>
	
	<footer id="footer">
		<p id="ZoneID"></p>
		<hr/>
			<a href="http://homidom.com"> HoMIDoM © 2011</a>	
			<br />
			<a href="http://www.homidom.com/mentions-legales-c2.html"> Mentions Légales </a>	
	</footer>
	
<script>

var ServerName = "";
var PortActuel = ""; 
var PortActuel = "";	
var IDSERVERActuel = "";
var ListDevices = [];
var urlapi  = "";

var zones = ko.observableArray([]);
var devices = ko.observableArray([]);
var macros = ko.observableArray([]);
var ListeServeurs = ko.observableArray([]);

var HeureLever = ko.observable();
var HeureCoucher = ko.observable();
var HeureAffiche = ko.observable();


var ErrorServer = false;
// Tooltip
$('[data-toggle="tooltip"]').tooltip();

    ko.applyBindings();	

	this.tick = function() { 
		var d = new Date();
		// Formatage de l'heure courante hh:mm:ss avec mise a jour toutes les 10s				
		 HeureAffiche(("0" + (d.getHours())).slice(-2)+":"+("0" + (d.getMinutes())).slice(-2)+":"+("0" + (d.getSeconds())).slice(-2));
		};	
	setInterval(this.tick, 10000);	
		
	// Affichage d'un message lors de l'execution d'une commande
	function onExecuteSuccess(url) {
		console.log("Commande envoyée sur l API HTTP avec l url "+ url);
	}
	
	function ConnectServer (){
	
		var d = new Date();
		$("#ZoneDate").empty();
		$("#ZoneDate").append("<h3>Nous sommes le :</h3>");
		$("#ZoneDate").append("<h2>"+d.toLocaleDateString().charAt(0).toUpperCase()+ d.toLocaleDateString().slice(1)+"</h2>");
	
		urlapi   = 'http://'+ AdresseIPActuel + ':'+ PortActuel + '/api/'+ IDSERVERActuel ;
		console.log("debug : "+urlapi);
		
		var connection = $.hubConnection('http://'+ AdresseIPActuel + ':' + PortActuel + '/live');

				var nHubProxy = connection.createHubProxy('NotificationHub');
				// Gestion du changement d'un Device
				nHubProxy.on('DeviceChanged', function (id, value) {
					console.log(id + ' = ' + value);
					var dName = getDeviceName(id, value);
					var d = new Date(); 
					var time = ("0" + (d.getHours())).slice(-2)+":"+("0" + (d.getMinutes())).slice(-2)+":"+("0" + (d.getSeconds())).slice(-2);
					console.log("Info recue : "+time+' / '+dName+' = ' + value);
					$('#events').prepend(time+' / '+dName+' = ' + value + '<br/>');
				});
				
				// Gestion des heures de lever et coucher du Soleil
				nHubProxy.on('HeureSoleilChanged', function (id, value) {
								console.log(' Changement de l heure du soleil '+ id + ' = ' + value);
				});
							
				nHubProxy.on('NewLog', function (TypLog,Source ,Fonction ,Message) {
					console.log(' Nouveau log recu ' + TypLog + ' = ' + Source + ' = ' + Fonction + ' = ' + Message);
					if (Fonction == 'MAJ_HeuresSoleil') {
						 var tempval = Message.split(":");
						 var TypeInfo = tempval[0];
						 console.log('Info recue : '+ TypeInfo);
						 switch (TypeInfo)
						{
							case 'Heure du lever ':
								HeureLever(Message.substr(Message.length-9,9)) ;     
							break;
							
							case 'Heure du coucher ':
								HeureCoucher(Message.substr(Message.length-9,9));			
							break;
						}	
					}
				});			
				
		// Connexion sur la gestion des events -  en cas d'erreur de connexion 
		connection.qs = { "sKey" : IDSERVERActuel };
		connection.start()	
			.done(function(){ 

				$("#ZoneDate").append("<h2>"+ServerName.toUpperCase() +' : '+ PortActuel + "</h2>");	
					$("#modalLogin").modal('hide');	
				console.log('Now connected, connection ID=' + connection.id); 
				$("#PartGauche").show();
				$("#PartCentrale").show();
				$("#PartDroite").show();
		
				// Recuperation des devices via API
				$.jsonp({
					url: urlapi + '/device/',
					callbackParameter: "callback",
					success: loadDevices,
					error: onError
				})
				// Recuperation des zones via API
				$.jsonp({
					url: urlapi + '/zone/',
					callbackParameter: "callback",
					success: loadZones,
					error: onError
					})
				// Recuperation des macros via API
				$.jsonp({
					url: urlapi + '/macro/',
					callbackParameter: "callback",
					success: loadMacros,
					error: onError
				})	
			})
			
			.fail(function(){ 
			alert('Erreur SignalR : Connexion impossible avec ' + urlapi);
			$('#modalLogin').modal('show');
			console.log('Could not connect'+ urlapi); 
		});		
	}


	// Recupere le nom du Device a partir de son ID
	function getDeviceName(id, value) {
		for (var a=0; a < ListDevices.length; a++)
		{
			 if (ListDevices[a]._ID == id) {
				 ListDevices[a]._Value = value; 
				 return ListDevices[a]._Name;
			}
		}
	}	

	function execute(deviceId, command) {
		$.jsonp({
			url: urlapi + '/command/device/'+deviceId+'/'+command,
			
			type: 'GET',
			callbackParameter: "callback",
			success: onExecuteSuccess,
			error: onError
		})
	}
		
 	function loadDevices(data) {
		var items = [];
		ListDevices = data;
	}
	
	// Chargement de zones 
 	function loadZones(data) {
		ListZones = data;
		$.each(data, function(index, zone) {
				 var zonetemp = {
					 "name":  zone._Name,
					 "id": zone._Id
				};
				zones.push(zonetemp);
		 });
	}
	
//	function AfficheZone(ZoneDefined) {
//		alert("Passage par AfficheZone pour " + ZoneDefined);
//	}
	function AfficheZone(ZoneDefined) {
			var items = [];
			var FirstItem = false;
			ZoneActuel = ZoneDefined; 	
		// Debug	
		// alert("passage par la fonction AfficheZone : "+ZoneDefined);
		
		ZoneIDText = ZoneDefined; 
		// alert('L Id de la zone est : ' + ZoneIDText );	
		// Supprime les elements deja affichés
		$('#devices').empty();
		
		$.each(ListZones, function(index, zone) {
			if (zone._Id == ZoneDefined){
				for (var i=0; i < zone._ListElement.length; i++)
				{
					if (zone._ListElement[i]._Visible) 
					{
						for (var a=0; a < ListDevices.length; a++)
						{
							if ( ListDevices[a]._ID == zone._ListElement[i]._ElementID)
							{
								// Widget Météo
								if (ListDevices[a]._Type==17) {
								items.push('<section id="WidMeteo"><h1>'+ListDevices[a]._Name + '</h1><h2>Actuellement</h2><div class="MeteoJour" title="Méteo actuelle"><article class="Info"><img src="./images/meteo/'+ ListDevices[a]._IconActuel +'.png" /><h3>'+ListDevices[a]._JourToday + '</h3></article><article class="Info"><img src="./images/meteo/temperature-defaut.png" /><h3>'+ListDevices[a]._TempActuel+ '°</h3></article><article class="Info"><img src="./images/meteo/humidite-defaut.png" /><h3>'+ ListDevices[a]._HumActuel + '%</h3></article><article class="Info"><img src="./images/meteo/vitessevent-defaut.png" /><h3>'+ListDevices[a]._VentActuel+ '</h3></article></div><div class="MeteoPrev" title="Prévisions"><article class="Prev"><img src="./images/meteo/'+ListDevices[a]._IconActuel + '.png" /><h4>'+ListDevices[a]._JourToday + '</h4><span title="Min" class="TempMin">'+ ListDevices[a]._MinToday + '°</span><span title="Max" class="TempMax">'+ ListDevices[a]._MaxToday + '°</span></article><article class="Prev"><img src="./images/meteo/'+ ListDevices[a]._IconJ1 + '.png" /><h4>'+ ListDevices[a]._JourJ1 + '</h4><span title="Min" class="TempMin">'+ ListDevices[a]._MinJ1 + '°</span><span title="Max" class="TempMax">'+ ListDevices[a]._MaxJ1 + '°</span></article><article class="Prev"><img src="./images/meteo/'+ ListDevices[a]._IconJ2 + '.png" /><h4>'+ ListDevices[a]._JourJ2 + '</h4><span title="Min" class="TempMin">'+ ListDevices[a]._MinJ2 + '°</span><span title="Max" class="TempMax">'+ ListDevices[a]._MaxJ2 + '°</span></article><article class="Prev"><img src="./images/meteo/'+ ListDevices[a]._IconJ3 + '.png" /><h4>'+ ListDevices[a]._JourJ3 + '</h4><span title="Min" class="TempMin">'+ ListDevices[a]._MinJ3 + '°</span><span title="Max" class="TempMax">'+ ListDevices[a]._MaxJ3 + '°</span></article></div>');
								items.push('</section>');		
								} 
								else {
								
								items.push('<article><h4>'+ListDevices[a]._Name + '</h4><div class="align_image"><img src="./images/devices/'+ListDevices[a]._Type+'-defaut.png" alt="" /> ' );
								var actions = [];
								actions.push('<div id="ListCommand" class="btn-group"><button class="btn btn-danger"> ' + ListDevices[a]._Value+ '</button>');
								actions.push('<button class="btn btn-danger dropdown-toggle" data-toggle="dropdown">');
								actions.push('<span class="caret"></span></button>');
								
								actions.push('<ul class="dropdown-menu">');
								$.each(ListDevices[a]._DeviceAction, function(i, command) {
																				
									if (command.Nom == "DIM"){
										actions.push('<li class="command"><span id="Slider"><input type="range" min="0" max="100" step="5" value="50" onchange="document.getElementById(\''+ListDevices[a]._Name+"Slider"+'\').innerHTML =this.value; execute(\''+ListDevices[a]._ID+'\', \''+command.Nom+'?Variation=this.value\'); \"  /><span id=\''+ListDevices[a]._Name+"Slider" + '\'class="badge pull-right"></span></span></li>');
									}
									 
									else {
										actions.push('<li class="command"><a href="#" onClick="execute(\''+ListDevices[a]._ID+'\', \''+command.Nom+'\')">' +command.Nom + '</a></li>');
								}
								  
								});
								 items.push(actions.join(''));	
								 items.push('</ul></div></article>');	
								} 
							}
						}
					}			 
				}
			}
		});

		$('<ul/>', {
			'class': 'devices',
			html: items.join('')
		}).appendTo('#devices');
	}	
	
	// Chargement de macros 	
	function loadMacros(data) {
		$.each(data, function(index, macro) {
			 var macrotemp = {
						 "name":  macro._Nom,
						 "id": macro._ID
					};
				macros.push(macrotemp);
		});
	}
	// Lancement de la macro Id via l'API
	function executeMacro(macroId) {
		var urltemp   = urlapi + '/command/macro/'+macroId+'/EXEC';
	
		$.jsonp({
			url: urltemp,
			type: 'GET',
			callbackParameter: "callback",
			success: onExecuteSuccess(urltemp),
			error: onError
		})
	}
	
	// Affichage en cas d'erreur de connexion 
	function onError(jqXHR, textStatus, errorThrown ) {
		if (ErrorServer==false) {
			alert('Erreur connexion impossible avec ' + urlapi);
			ErrorServer = true;
		}
		else  {
			alert('Erreur connexion effectuée avec ' + urlapi);
		}
	}

	$(document).ready(function(){ 
		var maxHeightPartDroite = ($( document ).height() - $("#header").height() - $("#footer").height())*0.95 ;
		var maxHeightEvent = maxHeightPartDroite*0.90;
		console.log("Taille Header : " + $( document ).height() +"/"+ $("#header").height()+"/"+ $("#footer").height() );
		console.log("Taille Header Events : " + maxHeightEvent );		
		$("#events").css('max-height',maxHeightEvent);
		$("#PartDroite").css('max-height',maxHeightPartDroite +'px');
		
		$("#PartGauche").hide();
		$("#PartCentrale").hide();
		$("#PartDroite").hide();
		ReadSites();
	});
			
</script>
</body>
</html>
